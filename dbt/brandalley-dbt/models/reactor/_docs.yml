version: 2

models:
  - name: order_issues_alert
    description: ""
    columns:
      - name: orderid
        description: ""
        meta:
          dimension:
            label: 'Order ID'
            format: id
      - name: customerid
        description: ""
        meta:
          dimension:
            label: 'Customer ID'
            format: id
      - name: sku
        description: ""
        meta:
          dimension:
            label: 'SKU'
            format: id
      - name: ext_order_number
        description: ""
        meta:
          dimension:
            label: 'Ext. Order ID'
            format: id

  - name: stg__reactor_stock_profile
    description: ""
    columns:
      - name: logged_date
      - name: sku
      - name: reactor_sku_id
      - name: on_hand
      - name: allocated
      - name: available
      - name: unsellable
      - name: unsellable_good
      - name: unsellable_bad

  - name: stg__reactor_goods_in
    description: ""
    columns:
      - name: po_id
        meta:
          dimension:
            label: 'PO ID'
          metrics:
            goods_in_pos:
              label: 'Goods In POs'
              type: count_distinct
              description: 'Number of POs Checked in'
              round: 0
      - name: sku
        meta:
          dimension:
            label: 'Magento SKU'
      - name: date_arrived
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Arrived Date'
      - name: qty_arrived
        meta:
          dimension:
            label: 'Qty Arrived'
          metrics:
            goods_in_qty_sum:
              label: 'Goods In Qty'
              type: sum
              description: 'Number of Units Checked in'
              round: 0
            x_dock_goods_in_qty_sum:
              label: 'X Dock Goods In Qty'
              type: sum
              description: 'Number of X Dock units checked in'
              sql: "if(${stock_type} = 'X Dock', ${qty_arrived}, 0)"
              round: 0
            pct_of_goods_in_x_dock:
              label: '% X Dock Goods In'
              type: number
              format: 'percent'
              description: 'Percent of units checked in which are x dock'
              sql: "safe_divide(${x_dock_goods_in_qty_sum},${goods_in_qty_sum})"
              round: 2
      - name: src
        meta:
          dimension:
            label: 'Data Source'
      - name: warehouse
        meta:
          dimension:
            label: 'Warehouse'
      - name: supplier
        meta:
          dimension:
            label: 'Supplier'
      - name: company
        meta:
          dimension:
            label: 'Company'
      - name: stock_type
        meta:
          dimension:
            label: 'Stock Type'

  - name: stock_exited
    description: ""
    columns:
      - name: logged_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Logged Date'
      - name: reactor_sku
        meta:
          dimension:
            label: 'Reactor Sku'
            type: string
      - name: magento_sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: qty_exited
        meta:
          dimension:
            hidden: true
          metrics:
            qty_exited_metric:
              type: sum
              label: 'Qty Exited'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'
      - name: exit_route
        meta:
          dimension:
            label: 'Exit Route'
      - name: exit_details
        meta:
          dimension:
            label: 'Exit Details'

  - name: delivery_consignment
    description: ""
    columns:
      - name: customerid
        meta:
          dimension:
            label: 'Customer ID'
      - name: ext_order_id
        meta:
          dimension:
            label: 'Magento Order ID'
      - name: reactor_pid
        meta:
          dimension:
            label: 'Reactor PID'
      - name: productname
        meta:
          dimension:
            label: 'Product Name'
      - name: units_qty
        meta:
          dimension:
            label: 'Unit Qty'
          metrics:
            units_dispatched_sum:
              label: 'Units Dispatched'
              type: sum
              description: 'Number of Items Dispatched'
              sql: "if(${status} = 'Shipped', ${units_qty}, 0)"
              round: 0
            express_units_dispatched_sum:
              label: 'Express Units Dispatched'
              type: sum
              description: 'Number of Express Items Dispatched'
              sql: "if(${status} = 'Shipped' and ${service_level} = 'Express', ${units_qty}, 0)"
              round: 0
      - name: delivery_consignment_id
        meta:
          dimension:
            label: 'Delivery Consignment ID'
          metrics:
            shipments_dispatched_sum:
              label: 'Shipments Dispatched'
              type: count_distinct
              description: 'Number of Shipments Dispatched'
              sql: "if(${status} = 'Shipped', ${delivery_consignment_id}, null)"
              round: 0
            express_shipments_dispatched_sum:
              label: 'Express Shipments Dispatched'
              type: count_distinct
              description: 'Number of Express Shipments Dispatched'
              sql: "if(${status} = 'Shipped' and ${service_level} = 'Express', ${delivery_consignment_id}, null)"
              round: 0
            express_shipments_pct:
              label: '% Shipments Express'
              type: number
              format: 'percent'
              description: '% of Shipments which are Express'
              sql: "safe_divide(${express_shipments_dispatched_sum},$shipments_dispatched_sum})"
              round: 0
            average_units_per_shipment:
              label: 'Shipments Dispatched'
              type: number
              description: 'Number of Shipments Dispatched'
              sql: "safe_divide(${units_dispatched_sum},${shipments_dispatched_sum})"
              round: 2
      - name: delivery_type
        meta:
          dimension:
            label: 'Delivery Type'
      - name: created_at
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Created At'
      - name: left_warehouse_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Left Warehouse Date'
      - name: ship_by
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Ship By'
      - name: charge
        meta:
          dimension:
            label: 'Delivery Charge'
      - name: package_id
        meta:
          dimension:
            label: 'Package ID'
      - name: weight
        meta:
          dimension:
            label: 'Weight'
      - name: length
        meta:
          dimension:
            label: 'Length'
      - name: width
        meta:
          dimension:
            label: 'Width'
      - name: height
        meta:
          dimension:
            label: 'Height'
      - name: dispatch_time_hours
        meta:
          dimension:
            label: 'Dispatch Time Hours'
          metrics:
            average_dispatch_time:
              label: 'Average Dispatch Time'
              type: average
              description: 'The average time it takes to dispatch an order'
              sql: "if(${status} = 'Shipped', ${dispatch_time_hours}, null)"
              round: 2
      - name: dispatch_time_days
        meta:
          dimension:
            label: 'Dispatch Time Days'
      - name: status
        meta:
          dimension:
            label: 'Status'
      - name: shipped_on_time
        meta:
          dimension:
            label: 'Shipped on Time'
      - name: undispatched_days_old
        meta:
          dimension:
            label: 'Undispatched Days Old'
          metrics:
            average_undispatched_days:
              label: 'Average Undispatched Days'
              type: average
              description: 'The average days that current undispatched items have been waiting for'
              sql: "if(${status} = 'Unshipped', ${undispatched_days_old}, null)"
              round: 2
      - name: late_unshipped_flag
        meta:
          dimension:
            label: 'Unshipped and Late'
      - name: service_level
        meta:
          dimension:
            label: 'Service Level'
      - name: ship_to_postcode
        meta:
          dimension:
            label: 'Delivery Postcode'
      - name: package_code
        meta:
          dimension:
            label: 'Package Code'
      - name: magento_sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'

  - name: return_rans
    description: ""
    columns:
      - name: customerid
        meta:
          dimension:
            label: 'Customer ID'
          metrics:
            returns_processed:
              label: 'Returns Processed'
              type: count_distinct
              description: 'Number of Returns we have processed'
              sql: "if(${completed} = 'Returned', ${customerid}, null)"
              round: 0
            returns_outstanding:
              label: 'Returns Outstanding'
              type: count_distinct
              description: 'Number of Returns that are outstanding'
              sql: "if(${completed} = 'Outstanding', ${customerid}, null)"
              round: 0
      - name: quantity
        meta:
          dimension:
            label: 'Quantity'
          metrics:
            returned_units_sum:
              label: 'Returns Units Processed'
              type: sum
              description: 'Number of Units Returned'
              sql: "if(${completed} = 'Returned', ${quantity}, 0)"
              round: 0
            outstanding_units_sum:
              label: 'Outstanding Units'
              type: sum
              description: 'Number of Units Outstanding'
              sql: "if(${completed} = 'Outstanding', ${quantity}, 0)"
              round: 0
            units_per_return:
              label: 'Units Per Return'
              type: number
              format: 'percent'
              description: 'Average number of units in a return'
              sql: "safe_divide(${returned_units_sum},${returns_processed})"
              round: 2
      - name: completed
        meta:
          dimension:
            label: 'Completed'
      - name: received_at_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Received at Date'
      - name: resaleable_qty
        meta:
          dimension:
            label: 'Resaleable Qty'
          metrics:
            resaleable_units_sum:
              label: 'Resaleable Units Processed'
              type: sum
              description: 'Number of Resaleable Units Returned'
              sql: "if(${completed} = 'Returned', ${resaleable_qty}, 0)"
              round: 0
      - name: damaged_qty
        meta:
          dimension:
            label: 'Damaged Qty'
          metrics:
            damaged_units_sum:
              label: 'Damaged Units Processed'
              type: sum
              description: 'Number of Damaged Units Returned'
              sql: "if(${completed} = 'Returned', ${damaged_qty}, 0)"
              round: 0
      - name: created_at_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'RAN Created Date'
      - name: order_posting_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Ordered At Date'
      - name: return_reason
        meta:
          dimension:
            label: 'Return Reason'
      - name: ext_order_id
        meta:
          dimension:
            label: 'Order ID'
      - name: reactor_sku
        meta:
          dimension:
            label: 'Reactor Sku'
      - name: magento_sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: product_name
        meta:
          dimension:
            label: 'Product Name'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'
      - name: tracking_number
        meta:
          dimension:
            label: 'Tracking Number'

  - name: purchase_orders
    description: ""
    columns:
      - name: po_number
        meta:
          dimension:
            label: 'PO Number'
      - name: reactor_sku
        meta:
          dimension:
            label: 'Reactor Sku'
      - name: magento_sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: productname
        meta:
          dimension:
            label: 'Product Name'
      - name: created_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Created Date'
      - name: arrived_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Arrived Date'
      - name: status
        meta:
          dimension:
            label: 'Status'
      - name: qty_ordered
        meta:
          dimension:
            label: 'Qty Ordered'
      - name: qty_received
        meta:
          dimension:
            label: 'Qty Received'
      - name: qty_outstanding
        meta:
          dimension:
            label: 'Qty Outstanding'      
      - name: supplier
        meta:
          dimension:
            label: 'Supplier'
      - name: stock_type
        meta:
          dimension:
            label: 'Stock Type'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'
      - name: whistl_stock_type
        meta:
          dimension:
            label: 'Whistl Stock Type'

  - name: box_names
    description: ""
    columns:
      - name: box_id
        tests:
          - unique
          - not_null
        meta:
          dimension:
            label: 'Box ID'
      - name: aislenumber
        meta:
          dimension:
            label: 'Aisle Number'
      - name: racknumber
        meta:
          dimension:
            label: 'Rack Number'
      - name: zone_
        meta:
          dimension:
            label: 'Zone'
      - name: box_name
        meta:
          dimension:
            label: 'Box Name'
      - name: last_checked
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Last Checked'
      - name: last_stock_check_month
        meta:
          dimension:
            label: 'Stock Last Checked Month'

  - name: stocklist_product_info
    description: ""
    columns:
      - name: reactor_sku
        tests:
          - unique
          - not_null
        meta:
          dimension:
            label: 'Reactor Sku'
      - name: barcode
        meta:
          dimension:
            label: 'Barcode'
      - name: productid
        meta:
          dimension:
            label: 'Product ID'
      - name: productname
        meta:
          dimension:
            label: 'Product Name'
      - name: magento_sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'

  - name: box_stock_logs
    description: ""
    meta:
      label: 'Box Stock Logs'
      joins:
        - join: box_names
          sql_on: ${box_stock_logs.boxid} = ${box_names.box_id}
        - join: stocklist_product_info
          sql_on: ${box_stock_logs.reactor_sku} = ${stocklist_product_info.reactor_sku}
    columns:
      - name: boxid
        meta:
          dimension:
            label: 'Box ID'
      - name: reactor_sku
        meta:
          dimension:
            label: 'Reactor Sku'
      - name: previous_qty
        meta:
          dimension:
            label: 'Qty Before Log'
      - name: logged_at
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Logged At'
      - name: scanned_qty
        meta:
          dimension:
            label: 'Qty After Log'
      - name: difference_qty
        meta:
          dimension:
            label: 'Qty Scanned'
          metrics:
            difference_qty_sum:
              label: 'Sum Qty Scanned'
              type: sum
              description: 'The sum of the difference qty'
              round: 0
      - name: name
        meta:
          dimension:
            label: 'Log Name'
      - name: unit_cost
        meta:
          dimension:
            label: 'Unit Cost'
      - name: difference_value
        meta:
          dimension:
            label: 'Value Scanned'
          metrics:
            difference_value_sum:
              label: 'Sum Value Scanned'
              type: sum
              description: 'The sum of the difference valu'
              round: 0

  - name: box_stock_locations
    description: ""
    meta:
      label: 'Box Stock Locations'
      joins:
        - join: box_names
          sql_on: ${box_stock_locations.box_id} = ${box_names.box_id}
    columns:
      - name: logged_date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            label: 'Logged Date'
            sql: 'if(min(${logged_date}) over (order by ${logged_date}) = ${logged_date} or max(${logged_date}) over (order by ${logged_date} desc) = ${logged_date}, ${logged_date}, null})' ## Hopefully this works if I filter on the report where logged_date is not null?
      - name: sku
        meta:
          dimension:
            label: 'Magento Sku'
      - name: reactor_sku_id
        meta:
          dimension:
            label: 'Reactor Sku'
      - name: box_id
        meta:
          dimension:
            label: 'Box ID'
      - name: on_hand
        meta:
          dimension:
            label: 'Qty'
          metrics:
            qty_sum:
              label: 'Total Qty'
              type: sum
              description: 'Sum of total qty'
      - name: allocated
        meta:
          dimension:
            label: 'Qty Allocated'
          metrics:
            qty_allocated_sum:
              label: 'Total Qty Allocated'
              type: sum
              description: 'Sum of total allocated qty'
      - name: available
        meta:
          dimension:
            label: 'Qty Available'
          metrics:
            qty_available_sum:
              label: 'Total Qty Available'
              type: sum
              description: 'Sum of total available qty'