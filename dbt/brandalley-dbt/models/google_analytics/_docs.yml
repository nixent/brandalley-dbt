version: 2

models:
  - name: ga_daily_stats
    description: "GA visit and transaction counts"
    meta:
      label: "Conversions GA"
      joins:
        - join: catalog_product
          sql_on: ${ga_daily_stats.product_sku} = ${catalog_product.sku} and ${catalog_product.ba_site} = 'UK'
        - join: products_sales
          sql_on: ${ga_daily_stats.product_sku} = ${products_sales.sku} and ${ga_daily_stats.date} >= date(${products_sales.sale_start_at}) and ${ga_daily_stats.date} < date(${products_sales.sale_end_at}) and ${products_sales.variant_sku_per_sku_per_sale_number} = 1 and ${products_sales.ba_site} = 'UK'
        - join: orders_enriched
          sql_on: ${ga_daily_stats.transaction_id} = ${orders_enriched.increment_id} and ${orders_enriched.ba_site} = 'UK'
        - join: customers_enriched
          sql_on: ${orders_enriched.customer_id} = ${customers_enriched.customer_id} and ${customers_enriched.ba_site} = 'UK'
        - join: OrderLines
          sql_on: ${ga_daily_stats.transaction_id} = ${OrderLines.order_number} and ${ga_daily_stats.product_sku} = ${OrderLines.parent_sku} and ${ga_daily_stats.product_sku_offset} = ${OrderLines.parent_sku_offset} and ${OrderLines.ba_site} = 'UK'
        - join: customers
          sql_on: ${OrderLines.customer_id} = ${customers.cst_id} and ${customers.ba_site} = 'UK'
        - join: affiliate_publishers
          sql_on: ${ga_daily_stats.traffic_campaign} = ${affiliate_publishers.publisher_id}
        - join: product_fulfillment_types_daily
          sql_on: date(${ga_daily_stats.view_at}) = ${product_fulfillment_types_daily.date_day} and ${product_fulfillment_types_daily.ba_site} = 'UK' and ${ga_daily_stats.product_sku} = ${product_fulfillment_types_daily.parent_sku}
    columns:
      - name: unique_key
        tests:
          - unique:
              config:
                where: "date >= current_date"
          - not_null:
              config:
                where: "date >= current_date"

      - name: date
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
      - name: is_new_user
        meta:
          dimension:
            type: boolean
      - name: visit_start_at
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'datetime(ga_daily_stats.visit_start_at, "Europe/London")'
      - name: view_at
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
      - name: traffic_channel
      - name: traffic_medium
      - name: traffic_campaign
      - name: traffic_source
      - name: device_browser
      - name: device_os
        meta:
          dimension:
            label: 'Device OS'
      - name: product_sku
      - name: product_sku_offset
      - name: product_name
      - name: product_brand
      - name: product_quantity
        meta:
          metrics:
            total_quantity_metric:
              label: 'GA Units'
              type: sum
              sql: "coalesce(if(${ga_daily_stats.transaction_id} is not null, ${ga_daily_stats.product_quantity}, null),0)"
              description: "Total quantity ordered"
      - name: transaction_id
        meta:
          metrics:
            total_transactions_metric:
              label: 'GA Transactions'
              type: count_distinct
              description: "Count of transactions"
            ga_conversion_rate:
              label: 'GA Conversion Rate (%)'
              type: number 
              description: 'Total transactions / Total visits'
              sql: "coalesce(safe_divide(${total_transactions_metric},${total_visits_metric}),0)"
              round: 2
              format: 'percent'
      - name: product_revenue
        meta:
          metrics:
            total_revenue_metric:
              label: 'GA GMV Before Discount (£/€)'
              type: sum
              description: "GMV"
              round: 0 
      - name: visit_id
      - name: visitor_id
        meta:
          metrics:
            total_users_metric:
              label: 'GA Users'
              type: count_distinct
              description: "Total users"
      - name: unique_visit_id
        meta:
          metrics:
            total_visits_metric:
              label: 'GA Visits'
              type: count_distinct
              description: "Total visits"
      - name: experiment
      - name: page_path
      - name: is_new_user_registration
        meta:
          metrics:
            ga_user_registrations:
              label: 'GA Registrations'
              type: count_distinct
              sql: 'if(${is_new_user_registration}, ${visitor_id}, null)'     