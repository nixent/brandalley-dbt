version: 2

models:
  - name: ga_daily_stats
    description: "GA visit and transaction counts"
    meta:
      label: "Conversions GA"
      joins:
        - join: catalog_product
          sql_on: ${ga_daily_stats.product_sku} = ${catalog_product.sku}
        - join: products_sales
          sql_on: ${ga_daily_stats.product_sku} = ${products_sales.sku}
        - join: orders_enriched
          sql_on: ${ga_daily_stats.transaction_id} = ${orders_enriched.increment_id}
        - join: customers_enriched
          sql_on: ${orders_enriched.customer_id} = ${customers_enriched.customer_id}
        - join: OrderLines
          sql_on: ${ga_daily_stats.transaction_id} = ${OrderLines.order_number} and ${ga_daily_stats.product_sku} = ${OrderLines.parent_sku} and ${ga_daily_stats.product_sku_offset} = ${OrderLines.parent_sku_offset}
        - join: customers
          sql_on: ${OrderLines.customer_id} = ${customers.cst_id}
    columns:
      - name: unique_key
        tests:
          - unique:
              config:
                where: "date >= current_date"
          - not_null:
              config:
                where: "date >= current_date"

      - name: date
        meta:
          dimension:
            type: date
      - name: is_new_user
        meta:
          dimension:
            type: boolean
      - name: traffic_channel
      - name: traffic_medium
      - name: traffic_campaign
      - name: traffic_source
      - name: device_browser
      - name: device_os
        meta:
          dimension:
            label: 'Device OS'
      - name: product_sku
      - name: product_sku_offset
      - name: product_name
      - name: product_brand
      - name: product_quantity
        meta:
          metrics:
            total_quantity_metric:
              label: 'Quantity ordered'
              type: sum
              sql: "coalesce(if(${ga_daily_stats.transaction_id} is not null, ${ga_daily_stats.product_quantity}, null),0)"
              description: "Total quantity ordered"
      - name: transaction_id
        meta:
          metrics:
            total_transactions_metric:
              label: 'Transactions'
              type: count_distinct
              description: "Count of transactions"
            ga_conversion_rate:
              label: 'Conversion Rate (%)'
              type: number 
              description: 'Total transactions / Total visits'
              sql: "coalesce(safe_divide(${total_transactions_metric},${total_visits_metric}),0)"
              round: 2
              format: 'percent'
      - name: product_revenue
        meta:
          metrics:
            total_revenue_metric:
              label: 'GMV Before Discount (Â£)'
              type: sum
              description: "GMV"
              round: 0
              format: 'gbp' 
      - name: visit_id
        meta:
          metrics:
            total_users_metric:
              label: 'Users'
              type: count_distinct
              description: "Total users"
      - name: visitor_id
      - name: unique_visit_id
        meta:
          metrics:
            total_visits_metric:
              label: 'Visits'
              type: count_distinct
              description: "Total visits"
      - name: experiment
        