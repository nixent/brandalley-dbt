{{config(
    materialized='incremental',
    unique_key='ba_site_item_id',
	cluster_by='order_id',
    partition_by = {
      "field": "bq_last_processed_at",
      "data_type": "timestamp",
      "granularity": "day"
    }
)}}

select
    'UK-' || {{ config.get('unique_key')|replace('ba_site_', '') }} as {{ config.get('unique_key') }},
    'UK'                                                            as ba_site,
    item_id,
    order_id,
    parent_item_id,
    quote_item_id,
    store_id,
    timestamp(created_at) as created_at,
    timestamp(updated_at) as updated_at,
    product_id,
    product_type,
    product_options,
    weight,
    is_virtual,
    sku,
    name,
    description,
    applied_rule_ids,
    additional_data,
    free_shipping,
    is_qty_decimal,
    no_discount,
    qty_backordered,
    qty_canceled,
    qty_invoiced,
    qty_ordered,
    qty_refunded,
    qty_shipped,
    base_cost,
    price,
    base_price,
    original_price,
    base_original_price,
    tax_percent,
    tax_amount,
    base_tax_amount,
    tax_invoiced,
    base_tax_invoiced,
    discount_percent,
    discount_amount,
    base_discount_amount,
    discount_invoiced,
    base_discount_invoiced,
    amount_refunded,
    base_amount_refunded,
    row_total,
    base_row_total,
    row_invoiced,
    base_row_invoiced,
    row_weight,
    base_tax_before_discount,
    tax_before_discount,
    ext_order_item_id,
    locked_do_invoice,
    locked_do_ship,
    price_incl_tax,
    base_price_incl_tax,
    row_total_incl_tax,
    base_row_total_incl_tax,
    hidden_tax_amount,
    base_hidden_tax_amount,
    hidden_tax_invoiced,
    base_hidden_tax_invoiced,
    hidden_tax_refunded,
    base_hidden_tax_refunded,
    is_nominal,
    tax_canceled,
    hidden_tax_canceled,
    tax_refunded,
    base_tax_refunded,
    discount_refunded,
    base_discount_refunded,
    gift_message_id,
    gift_message_available,
    base_weee_tax_applied_amount,
    base_weee_tax_applied_row_amnt,
    weee_tax_applied_amount,
    weee_tax_applied_row_amount,
    weee_tax_applied,
    weee_tax_disposition,
    weee_tax_row_disposition,
    base_weee_tax_disposition,
    base_weee_tax_row_disposition,
    event_id,
    giftregistry_item_id,
    gw_id,
    gw_base_price,
    gw_price,
    gw_base_tax_amount,
    gw_tax_amount,
    gw_base_price_invoiced,
    gw_price_invoiced,
    gw_base_tax_amount_invoiced,
    gw_tax_amount_invoiced,
    gw_base_price_refunded,
    gw_price_refunded,
    gw_base_tax_amount_refunded,
    gw_tax_amount_refunded,
    qty_returned,
    nego,
    qty_warehouse_sent,
    qty_out_of_stock,
    qty_backorder_reconciliation,
    dispatch_date,
    backorder_availability,
    out_of_stock_date,
    qty_reserved_by_tc,
    qty_refunded_hold,
    qty_returned_to_warehouse,
    sales_product_type,
    expected_delivery_consignment,
    qty_reserved_by_wh_b,
    qty_wh_b_sent,
    product_personalisation,
    _streamkap_source_ts_ms,
    _streamkap_ts_ms,
    _streamkap_offset,
    _streamkap_loaded_at_ts,
    __deleted,
    bq_last_processed_at
from {{ ref('stg_uk__sales_flat_order_item') }}
{% if is_incremental() %}
    where bq_last_processed_at > (select max(bq_last_processed_at) from {{this}} where ba_site = 'UK' )
{% endif %}

union all

select
    'FR-' || {{ config.get('unique_key')|replace('ba_site_', '') }} as {{ config.get('unique_key') }},
    'FR'                                                            as ba_site,
    item_id,
    order_id,
    parent_item_id,
    quote_item_id,
    store_id,
    created_at,
    updated_at,
    product_id,
    product_type,
    product_options,
    weight,
    is_virtual,
    sku,
    name,
    description,
    applied_rule_ids,
    additional_data,
    free_shipping,
    is_qty_decimal,
    no_discount,
    qty_backordered,
    qty_canceled,
    qty_invoiced,
    qty_ordered,
    qty_refunded,
    qty_shipped,
    base_cost,
    price,
    base_price,
    original_price,
    base_original_price,
    tax_percent,
    tax_amount,
    base_tax_amount,
    tax_invoiced,
    base_tax_invoiced,
    discount_percent,
    discount_amount,
    base_discount_amount,
    discount_invoiced,
    base_discount_invoiced,
    amount_refunded,
    base_amount_refunded,
    row_total,
    base_row_total,
    row_invoiced,
    base_row_invoiced,
    row_weight,
    base_tax_before_discount,
    tax_before_discount,
    ext_order_item_id,
    locked_do_invoice,
    locked_do_ship,
    price_incl_tax,
    base_price_incl_tax,
    row_total_incl_tax,
    base_row_total_incl_tax,
    hidden_tax_amount,
    base_hidden_tax_amount,
    hidden_tax_invoiced,
    base_hidden_tax_invoiced,
    hidden_tax_refunded,
    base_hidden_tax_refunded,
    is_nominal,
    tax_canceled,
    hidden_tax_canceled,
    tax_refunded,
    base_tax_refunded,
    discount_refunded,
    base_discount_refunded,
    gift_message_id,
    gift_message_available,
    base_weee_tax_applied_amount,
    base_weee_tax_applied_row_amnt,
    weee_tax_applied_amount,
    weee_tax_applied_row_amount,
    weee_tax_applied,
    weee_tax_disposition,
    weee_tax_row_disposition,
    base_weee_tax_disposition,
    base_weee_tax_row_disposition,
    event_id,
    giftregistry_item_id,
    gw_id,
    gw_base_price,
    gw_price,
    gw_base_tax_amount,
    gw_tax_amount,
    gw_base_price_invoiced,
    gw_price_invoiced,
    gw_base_tax_amount_invoiced,
    gw_tax_amount_invoiced,
    gw_base_price_refunded,
    gw_price_refunded,
    gw_base_tax_amount_refunded,
    gw_tax_amount_refunded,
    qty_returned,
    nego,
    qty_warehouse_sent,
    qty_out_of_stock,
    qty_backorder_reconciliation,
    date('1970-01-01') + dispatch_date as dispatch_date,
    backorder_availability,
    timestamp_micros(unix_micros(timestamp(date('1970-01-01') + out_of_stock_date))) as out_of_stock_date,
    qty_reserved_by_tc,
    qty_refunded_hold,
    qty_returned_to_warehouse,
    sales_product_type,
    expected_delivery_consignment,
    qty_reserved_by_wh_b,
    qty_wh_b_sent,
    product_personalisation,
    _streamkap_source_ts_ms,
    _streamkap_ts_ms,
    _streamkap_offset,
    _streamkap_loaded_at_ts,
    __deleted,
    bq_last_processed_at
from {{ ref('stg_fr__sales_flat_order_item') }}
{% if is_incremental() %}
    where bq_last_processed_at > (select max(bq_last_processed_at) from {{this}} where ba_site = 'FR' )
{% endif %}