version: 2

models:
  - name: customers_enriched
    description: " table with a grain of one customer per row "
    meta:
      joins:
        - join: Orders
          sql_on: ${Orders.customer_id} = ${customers_enriched.customer_id}
    columns: 
      - name: customer_id
        tests:
          - unique
          - not_null
        meta:
          dimension:
            format: id
          metrics:
            customers_enriched_count:
              label: 'Count of customers'
              type: count_distinct
              description: "Count of customers"
              hidden: false
      - name: signed_up_at
        meta: 
          dimension:
            type: date
      - name: first_purchase_at
        meta: 
          dimension:
            type: date
      - name: first_purchase_brands
        meta: 
          dimension:
            type: string
            sql: array_to_string(${first_purchase_brands}, ', ')
      - name: second_purchase_at
        meta: 
          dimension:
            type: date
      - name: count_customer_orders
        meta: 
          dimension:
            type: number
      - name: customer_first_purchase_age_days
        meta: 
          dimension:
            type: number
      - name: first_to_second_order_interval
        meta:
          dimension:
            type: number
          metrics:
            average_first_to_second_order_interval_metric:
              label: 'Average days between first and second purchase'
              type: average
              description: "Average days between first and second purchase"
              hidden: false
              round: 0
            average_order_interval_within_90_days_metric:
              label: 'Average days between first and second purchase, when within 90 days'
              type: average
              description: "Average days between first and second purchase, when within 90 days"
              sql: "if(${first_to_second_order_interval} <= 90, ${first_to_second_order_interval}, null)"
              hidden: false
              round: 0
            average_order_interval_within_180_days_metric:
              label: 'Average days between first and second purchase, when within 180 days'
              type: average
              description: "Average days between first and second purchase, when within 180 days"
              sql: "if(${first_to_second_order_interval} <= 180, ${first_to_second_order_interval}, null)"
              hidden: false
              round: 0
            average_order_interval_within_270_days_metric:
              label: 'Average days between first and second purchase, when within 270 days'
              type: average
              description: "Average days between first and second purchase, when within 270 days"
              sql: "if(${first_to_second_order_interval} <= 270, ${first_to_second_order_interval}, null)"
              hidden: false
              round: 0
            average_order_interval_within_365_days_metric:
              label: 'Average days between first and second purchase, when within 365 days'
              type: average
              description: "Average days between first and second purchase, when within 365 days"
              sql: "if(${first_to_second_order_interval} <= 365, ${first_to_second_order_interval}, null)"
              hidden: false
            total_customers_second_order_within_90_days:
              label: 'Total number of customers who have made a second purchase within 90 days'
              type: count_distinct
              description: "Number of customers who have returned to make second order within 90 days"
              hidden: false
              sql: "if(${first_to_second_order_interval} <= 90, ${customer_id}, null)"
            total_customers_second_order_within_180_days:
              label: 'Total number of customers who have made a second purchase within 180 days'
              type: count_distinct
              description: "Number of customers who have returned to make second order within 180 days"
              hidden: false
              sql: "if(${first_to_second_order_interval} <= 180, ${customer_id}, null)"
            total_customers_second_order_within_270_days:
              label: 'Total number of customers who have made a second purchase within 9 months'
              type: count_distinct
              description: "Number of customers who have returned to make second order within 9 months"
              hidden: false
              sql: "if(${first_to_second_order_interval} <= 270, ${customer_id}, null)"
            total_customers_second_order_within_1_year:
              label: 'Total number of customers who have made a second purchase within 365 days'
              type: count_distinct
              description: "Number of customers who have returned to make second order within 365 days"
              hidden: false
              sql: "if(${first_to_second_order_interval} <= 365, ${customer_id}, null)"

  - name: customers_record_data_source
    description: ""
    columns:
      - name: cst_id
        description: ""
        meta:
          dimension:
            format: id
          metrics:
            new_members_customers_record:
              label: 'New Members from customers_record_data_source'
              type: count_distinct
              description: "New Members from customers_record_data_source"
              hidden: false    
      - name: record_data_source
        description: ""
      - name: date
        description: ""

  - name: customers
    description: "" 
    columns:
      - name: cst_id
        description: "Customer ID - primary key"
        tests:
          - unique
          - not_null
        meta:
          metrics:
            members:
              label: 'Members'
              type: count_distinct
              description: "Number of members"
              hidden: false    
            new_members:
              label: 'New Members'
              type: count_distinct
              description: "Number of new members"
              sql: "IF(${achica_user} is null OR ${achica_user} <> 2, ${cst_id}, 0)"
              hidden: false    
      - name: customer_name
        description: ""
      - name: email
        description: ""
      - name: telephone
        description: ""
      - name: billing_street
        description: ""
      - name: billing_city
        description: ""
      - name: billing_postcode
        description: ""
      - name: b_region
        description: ""
      - name: billing_country
        description: ""
      - name: shipping_street
        description: ""
      - name: shipping_city
        description: ""
      - name: shipping_postcode
        description: ""
      - name: s_region
        description: ""
      - name: s_country
        description: ""
      - name: dt_cr
        description: ""
        meta:
          dimension:
            type: date
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER']
      - name: subscription
        description: ""
      - name: old_account_id
        description: ""
        meta:
          dimension:
            format: id
      - name: third_party
        description: ""
      - name: updated_at
        description: ""
      - name: achica_user
        description: ""
      - name: achica_migration_date
        description: ""

  - name: log_customer
    description: ""
    columns:
      - name: log_id
        description: "Primary key"
        meta:
          dimension:
            format: id
      - name: visitor_id
        description: "Visitor id, nullable"
        meta:
          dimension:
            format: id
      - name: customer_id
        description: "Customer id"
        meta:
          dimension:
            format: id
      - name: login_at
        description: "Login time"
      - name: logout_at
        description: "Logout time, nullable"
      - name: store_id
        description: "Store id"
        meta:
          dimension:
            format: id
      - name: _streamkap_source_ts_ms
        description: ""
      - name: __deleted
        description: ""
