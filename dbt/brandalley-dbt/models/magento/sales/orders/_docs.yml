version: 2

models:
  - name: coupon_rules
    description: "Coupon details"
    columns:
      - name: ba_site
      - name: coupon_id
        description: "Primary key"
        meta:
          dimension:
            format: id
      - name: rule_id
        data_type: <integer>
        description: "Rule Id, nullable"
        meta:
          dimension:
            format: id
      - name: code
        data_type: <string>
        description: "Code"
      - name: usage_limit
        data_type: <integer>
        description: "Usage limit"
      - name: usage_per_customer
        data_type: <integer>
        description: "Usage per customer"
      - name: time_used
        data_type: <integer>
        description: "Number of times the coupon has been used"
      - name: expiration_date
        data_type: <string>
        description: "Expiration date"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(coupon_rules.ba_site = "FR",datetime(coupon_rules.expiration_date, "Europe/Paris"),datetime(coupon_rules.expiration_date, "Europe/London"))'        
      - name: is_primary
        data_type: <integer>
        description: "Is primary flag"
      - name: sales_rule_coupon_created_at
        data_type: <string>
        description: "Created date for coupon"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(coupon_rules.ba_site = "FR",datetime(coupon_rules.sales_rule_coupon_created_at, "Europe/Paris"),datetime(coupon_rules.sales_rule_coupon_created_at, "Europe/London"))'           
      - name: type
        data_type: <integer>
        description: "Type"
      - name: coupon_type_label
        description: "Readable Coupon Type, one of Marketing or Customer Service"
      - name: coupon_expired
        description: "Flag indicating if coupon is expired or not"
      - name: order_id
        description: "Id of order linked to coupon, nullable"
        meta:
          dimension:
            format: id
      - name: status
        description: "Order status"
      - name: base_discount_amount
        description: "Discount amount"
        meta:
          metrics:
            coupon_discount_amount:
              label: 'Discount amount'
              type: sum
              description: "Order discount amount"
              hidden: false
              round: 2      
      - name: base_discount_invoiced
        description: "Discount invoiced"
        meta:
          metrics:
            coupon_discount_invoiced:
              label: 'Order discount invoiced'
              type: sum
              description: "Discount invoiced"
              hidden: false
              round: 2      
      - name: discount_description
        description: "Discount description"
      - name: customer_id
        description: "Customer ID"
        meta:
          dimension:
            format: id
      - name: order_date
        description: "Date of the order"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(coupon_rules.ba_site = "FR",datetime(coupon_rules.order_date, "Europe/Paris"),datetime(coupon_rules.order_date, "Europe/London"))'            
      - name: invent_autocoupon_id
        description: "invent_autocoupon_id"
        meta:
          dimension:
            format: id
      - name: referral_coupon
        description: "Coupon code linked"
      - name: referee_coupon
        description: "Referee coupon"
        meta:
          dimension:
            format: id
      - name: reward_to
        description: "Reward to"
        meta:
          dimension:
            format: id
      - name: reward_from
        description: "Reward from"
        meta:
          dimension:
            format: id
      - name: invent_autocoupon_created_at
        description: "invent_autocoupon_created_at"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(coupon_rules.ba_site = "FR",datetime(coupon_rules.invent_autocoupon_created_at, "Europe/Paris"),datetime(coupon_rules.invent_autocoupon_created_at, "Europe/London"))'              
      - name: cartrule_id
        description: "Cartrule id"
        meta:
          dimension:
            format: id
      - name: basis_for_issue
        description: "Basis for issue"
      - name: coupon_reason
        description: "Reason coupon was issued"
      - name: comments_text
        description: "Comments text"
      - name: recommendation
        description: "Recommendation"
      - name: referral_couponid
        description: "Referral coupon id"
        meta:
          dimension:
            format: id
      - name: referee_couponid
        description: "Referee coupon id"
        meta:
          dimension:
            format: id
      - name: reward_from_old
        description: "Reward from old"
      - name: issuer_id
        description: "Issuer id"
        meta:
          dimension:
            format: id
      - name: salesrule_discount_amount
        description: "Discount value"
        meta:
          metrics:
            salesrule_discount_amount_value:
              label: 'Coupon discount value'
              type: sum
              description: "Discount value"
              hidden: false
              round: 2      

  - name: gift_cards
    description: "Gift cards"
    columns:
      - name: ba_site
      - name: order_id
        data_type: <integer>
        description: "Order id"
        meta:
          dimension:
            format: id
      - name: status
        description: "Status"
      - name: base_gift_cards_amount
        description: "Base gift card amount"
      - name: gift_cards_amount
        description: "Gift card amount"
      - name: base_gift_cards_invoiced
        description: "Base gift cards invoiced"
      - name: gift_cards_invoiced
        description: "Gift cards invoiced"
      - name: base_gift_cards_refunded
        description: "Base gift cards refunded"
      - name: gift_cards_refunded
        description: "Gift cards refunded"
      - name: order_date
        description: "Order date"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(gift_cards.ba_site = "FR",datetime(gift_cards.order_date, "Europe/Paris"),datetime(gift_cards.order_date, "Europe/London"))'     
      - name: date_created
        description: "Date created"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(gift_cards.ba_site = "FR",datetime(gift_cards.date_created, "Europe/Paris"),datetime(gift_cards.date_created, "Europe/London"))' 
      - name: date_expires
        description: "Date expires"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(gift_cards.ba_site = "FR",datetime(gift_cards.date_expires, "Europe/Paris"),datetime(gift_cards.date_expires, "Europe/London"))' 
      - name: balance
        description: "Balance"
        meta:
          metrics:
            gift_cards_balance:
              label: 'Gift cards balance'
              type: sum
              description: "Gift cards balance"
              hidden: false
              round: 2      
      - name: state
        description: "State"

  - name: hourly_sales_today
    description: "A view to query realtime orders by hour today, and compare to the same hour last week"
    columns:
      - name: ba_site
      - name: created_at_hour
      - name: nego
      - name: brand
      - name: category_name
      - name: department_type
      - name: parent_sku
      - name: product_type
      - name: supplier_name
      - name: qty_ordered_metric
        meta:
          dimension:
            hidden: true
          metrics:
            total_qty_ordered:
              type: sum
              round: 0
              label: 'Units Ordered'
      - name: total_revenue
        meta:
          dimension:
            hidden: true
          metrics:
            total_gmv:
              type: sum
              round: 0
            hourly_aov:
              type: number
              sql: 'safe_divide(sum(total_revenue),sum(total_order_count))'
              round: 0
              label: 'Hourly AOV'
      - name: line_product_cost_exc_vat_metric
        meta:
          dimension:
            hidden: true
          metrics:
            total_cost:
              type: sum
              round: 0 
              label: 'Product Cost'
      - name: total_revenue_exc_tax
        meta:
          dimension:
            hidden: true
          metrics:
            total_sales_amount:
              type: sum
              round: 0 
              label: 'Sales Amount'
      - name: margin_value
        meta:
          dimension:
            hidden: true
          metrics:
            total_margin:
              type: sum
              round: 0 
              label: 'Margin'
      - name: total_order_count
      - name: rc_gmv
        meta:
          dimension:
            hidden: true
          metrics:
            rc_aov:
              type: number
              sql: 'safe_divide(sum(rc_gmv),sum(total_existing_order_count))'
              round: 0
              label: 'RC AOV'
      - name: nc_gmv
        meta:
          dimension:
            hidden: true
          metrics:
            nc_aov:
              type: number
              sql: 'safe_divide(sum(nc_gmv),sum(total_new_order_count))'
              round: 0
              label: 'NC AOV'
      - name: total_discount_amount
        meta:
          dimension:
            hidden: true
          metrics:
            total_hourly_discount:
              type: sum
              round: 0
              label: 'Discount'
      - name: total_new_order_count
        meta:
          dimension:
            hidden: true
          metrics:
            total_hourly_new_orders:
              type: sum
              round: 0
              label: 'New Orders'
      - name: total_existing_order_count
        meta:
          dimension:
            hidden: true
          metrics:
            total_hourly_existing_orders:
              type: sum
              round: 0
              label: 'Existing Orders'
      - name: total_new_members
        meta:
          dimension:
            hidden: true
          metrics:
            total_hourly_new_members:
              type: sum
              round: 0
              label: 'New Members'
      - name: hour
      - name: last_week_margin
        meta:
          dimension:
            hidden: true
          metrics:
            total_margin_last_week:
              type: sum
              round: 0 
              label: 'Margin Last Week'
              group_label: 'Last Week'
      - name: last_week_qty_ordered
        meta:
          dimension:
            hidden: true
          metrics:
            total_qty_ordered_last_week:
              type: sum
              round: 0 
              label: 'Units Ordered Last Week'
              group_label: 'Last Week'
      - name: last_week_revenue
        meta:
          dimension:
            hidden: true
          metrics:
            total_sales_amount_last_week:
              type: sum
              round: 0 
              label: 'Sales Amount Last Week'
              group_label: 'Last Week'

  - name: multiple_coupon_orders
    description: "Orders that use multiple coupons, split by each of those coupons"
    columns:
      - name: ba_site
      - name: customer_id
        meta:
          dimension:
            format: id
      - name: order_id
        meta:
          dimension:
            format: id
      - name: increment_id
        meta:
          dimension:
            format: id
      - name: coupon_type_label
      - name: created_at
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(multiple_coupon_orders.ba_site = "FR",datetime(multiple_coupon_orders.created_at, "Europe/Paris"),datetime(multiple_coupon_orders.created_at, "Europe/London"))'
      - name: coupon_code
      - name: coupon_name

  - name: OrderLines
    description: ""
    meta:
      label: 'Order Lines'
      joins:
        - join: sales_flat_creditmemo
          sql_on: ${OrderLines.order_id} = ${sales_flat_creditmemo.order_id} and ${OrderLines.ba_site} = ${sales_flat_creditmemo.ba_site}
        - join: ba_core_stock_return
          sql_on: ${OrderLines.order_number} = ${ba_core_stock_return.order_increment_id} and ${OrderLines.ba_site} = ${ba_core_stock_return.ba_site}
        - join: sales_flat_creditmemo_item
          sql_on: ${OrderLines.sku} = ${sales_flat_creditmemo_item.sku} and ${sales_flat_creditmemo_item.order_id}=${OrderLines.order_id} and ${sales_flat_creditmemo_item.refund_status}='approved' and ${OrderLines.ba_site} = ${sales_flat_creditmemo_item.ba_site}
        - join: customers
          sql_on: ${OrderLines.customer_id} = ${customers.cst_id} and ${OrderLines.ba_site} = ${customers.ba_site}
        - join: Orders
          sql_on: ${OrderLines.order_number} = ${Orders.increment_id} and ${OrderLines.ba_site} = ${Orders.ba_site}
        - join: products
          sql_on: ${OrderLines.sku} = ${products.sku} and ${OrderLines.ba_site} = ${products.ba_site}
        - join: shipment_items
          sql_on: ${OrderLines.parent_item_id} = ${shipment_items.order_item_id} and ${OrderLines.ba_site} = ${shipment_items.ba_site}           
        - join: shipments
          sql_on: ${shipment_items.parent_id} = ${shipments.entity_id} and ${OrderLines.ba_site} = ${shipments.ba_site}
        - join: shipping
          sql_on: ${Orders.increment_id} = ${shipping.order_id} and ${OrderLines.sku} = ${shipping.sku} and ${OrderLines.ba_site} = ${shipping.ba_site}
        - join: catalog_product_negotiation_item
          sql_on: ${OrderLines.nego} = ${catalog_product_negotiation_item.negotiation_id} and ${OrderLines.sku} = ${catalog_product_negotiation_item.sku} and ${OrderLines.ba_site} = ${catalog_product_negotiation_item.ba_site}
        - join: customers_enriched 
          sql_on: ${OrderLines.customer_id} = ${customers_enriched.customer_id} and ${OrderLines.ba_site} = ${customers_enriched.ba_site}
        - join: orders_enriched
          sql_on: ${OrderLines.order_id} = ${orders_enriched.order_id} and ${OrderLines.ba_site} = ${orders_enriched.ba_site}

    columns:
      - name: ba_site
        meta:
          dimension:
            label: 'BA Site'
      - name: unique_id
        description: ""
        tests:
          - unique
          - not_null
        meta:
          dimension:
            hidden: true
      - name: months_since_cohort_start
        description: "no of months since cohort began"
        meta:
          dimension:
            type: number
            group_label: 'Customer Details'
      - name: years_since_cohort_start
        description: "no of years since cohort began" 
        meta: 
          dimension: 
            type: number
            group_label: 'Customer Details'
      - name : quarters_since_cohort_start
        description: "no of quarters since cohort began"
        meta:
          dimension:
            type: number
            group_label: 'Customer Details'
      - name: order_number
        description: ""
        meta:
          dimension:
            group_label: 'Order Info' 
      - name: customer_id
        description: "Customer id, foreign key, nullable" 
        meta:
          dimension:
            format: id
            group_label: 'Customer Details'
          metrics:
            total_customers:
              label: 'Total Customers'
              type: count_distinct
              description: "Number of customers who ordered"
              hidden: false
              round: 0      
              sql: "${ba_site} || ${customer_id}"
              group_label: 'Customers'
      - name: order_item_id
        description: "Order item id, foreign key"
        meta:
          dimension:
            format: id
            group_label: 'Order Info'    
          metrics:
            count_order_items:
              label: 'Total Order Items'
              type: count_distinct    
              sql: "${ba_site} || ${order_item_id}"
              group_label: 'Sales'
      - name: parent_item_id
        description: "Parent item id, foreign key"
        meta:
          dimension: 
            group_label: 'Product Details'
      - name: order_id
        description: "Id of the order, foreign key"
        meta:
          dimension:
            format: id
            group_label: 'Order Info'
          metrics:
            total_orders_count:
              label: 'Total Orders'
              type: count_distinct
              sql: "${ba_site} || ${order_id}"
              group_label: 'Sales'
            average_items_per_order:
              label: 'Avg Items per Order'
              type: number
              sql: " ${count_order_items} / ${total_orders_count} "
              group_label: 'Units'
      - name: sku
        description: "SKU, nullable"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: buyer
        description: "Buyer, nullable"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: name
        description: "Name"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: qty_canceled
        description: "Quantity canceled, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_canceled_metric:
              label: 'Total Cancelled Units'
              type: sum
              description: "Number of units cancelled"
              hidden: false
              round: 0      
              group_label: 'Units'
      - name: qty_ordered
        description: "Quantity ordered, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_ordered_metric:
              label: 'Total Ordered Units'
              type: sum
              description: "Number of units ordered"
              hidden: false
              round: 0  
              group_label: 'Units'
            average_qty_ordered_metric:
              label: 'Average Ordered Units'
              type: average 
              description: "Average number of units ordered"
              hidden: false
              round: 0
              group_label: 'Units'
      - name: qty_invoiced
        description: "Quantity invoiced, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_invoiced_metric:
              label: 'Total Invoiced Units'
              type: sum
              description: "Number of units invoiced"
              hidden: false
              round: 0
              group_label: 'Units'      
      - name: qty_refunded
        description: "Quantity refunded, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_refunded_metric:
              label: 'Total Refunded Units'
              type: sum
              description: "Number of units refunded"
              hidden: false
              round: 0
              group_label: 'Units'     
      - name: qty_shipped
        description: "Quantity shipped, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_shipped_metric:
              label: 'Total Shipped Units'
              type: sum
              description: "Number of units shipped"
              hidden: false
              round: 0
              group_label: 'Units'      
      - name: consignment_qty
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            consignment_qty_metric:
              label: 'Total Consignment Units'
              type: sum
              description: "Number of consignment units ordered"
              hidden: false
              round: 0
              group_label: 'Units'     
            consignment_gmv_metric:
              label: 'Consignment GMV (£/€)'
              type: sum
              description: "Total consignment GMV"
              sql: "if(${consignment_qty} > 0, ${consignment_qty}*${total_local_currency_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'    
            consignment_sales_amount_metric:
              label: 'Consignment Sales Amount (£/€)'
              type: sum
              description: "Total consignment sales amount"
              sql: "if(${consignment_qty} > 0, ${consignment_qty}*${total_local_currency_ex_tax_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'
            consignment_product_cost_metric:
              label: 'Consignment Product Cost (£/€)'
              type: sum
              description: "Total consignment product cost"
              sql: "if(${consignment_qty} > 0, ${consignment_qty}*${product_cost_exc_vat},0)"
              round: 0
              group_label: 'Costs'        
      - name: selffulfill_qty
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            selfulfill_qty_metric:
              label: 'Total Self-fulfill Units'
              type: sum
              description: "Number of self-fulfill units ordered"
              hidden: false
              round: 0
              group_label: 'Units'     
            selffulfill_gmv_metric:
              label: 'Self-fulfill GMV (£/€)'
              type: sum
              description: "Total selffulfill GMV"
              sql: "if(${selffulfill_qty} > 0, ${selffulfill_qty}*${total_local_currency_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'    
            selffulfill_sales_amount_metric:
              label: 'Self-fulfill Sales Amount (£/€)'
              type: sum
              description: "Total selffulfill sales amount"
              sql: "if(${selffulfill_qty} > 0, ${selffulfill_qty}*${total_local_currency_ex_tax_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'
            selffulfill_product_cost_metric:
              label: 'Self-fulfill Product Cost (£/€)'
              type: sum
              description: "Total selffulfill product cost"
              sql: "if(${selffulfill_qty} > 0, ${selffulfill_qty}*${product_cost_exc_vat},0)"
              round: 0
              group_label: 'Costs'         
      - name: warehouse_qty
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            warehouse_qty_metric:
              label: 'Total Warehouse Units'
              type: sum
              description: "Number of warehouse units ordered"
              hidden: false
              round: 0
              group_label: 'Units'   
            warehouse_gmv_metric:
              label: 'Warehouse GMV (£/€)'
              type: sum
              description: "Total warehouse GMV"
              sql: "if(${warehouse_qty} > 0, ${warehouse_qty}*${total_local_currency_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'    
            warehouse_sales_amount_metric:
              label: 'Warehouse Sales Amount (£/€)'
              type: sum
              description: "Total warehouse sales amount"
              sql: "if(${warehouse_qty} > 0, ${warehouse_qty}*${total_local_currency_ex_tax_after_vouchers}/${qty_ordered},0)"
              round: 0
              group_label: 'Sales'
            warehouse_product_cost_metric:
              label: 'Warehouse Product Cost (£/€)'
              type: sum
              description: "Total warehouse product cost"
              sql: "if(${warehouse_qty} > 0, ${warehouse_qty}*${product_cost_exc_vat},0)"
              round: 0
              group_label: 'Costs'     
      - name: order_placed_date
        description: ""
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLines.ba_site = "FR",datetime(timestamp(OrderLines.order_placed_date), "Europe/Paris"),datetime(timestamp(OrderLines.order_placed_date), "Europe/London"))'
            group_label: 'Order Info'
          # metrics:
          #   date_difference_between_months:
          #     label: 'No of months since cohort start'
          #     type: max 
          #     description: 'No of months since cohort start'
          #     sql: " DATETIME_DIFF( SAFE_CAST(${OrderLines.order_placed_date} AS DATETIME),  ${customers.dt_cr}, MONTH )  "
          #     group_label: 
      - name: dispatch_due_date
        description: ""
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            group_label: 'Order Info'
      - name: product_cost_exc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            product_cost_exc_vat_metric:
              label: 'Total Product Cost (1 Unit)'
              type: sum
              description: "Cost exc VAT for 1 unit"
              hidden: false
              round: 2
              group_label: 'Costs'      
      - name: line_product_cost_exc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_product_cost_exc_vat_metric:
              label: 'Total Product Cost (All Units)'
              type: sum
              description: "Cost exc VAT for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Costs'      
      - name: flash_price_inc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            flash_price_inc_vat_metric:
              label: 'Flash Price inc VAT (All Units)'
              type: sum
              description: "Flash price inc VAT for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Prices'      
      - name: line_flash_price_inc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_flash_price_inc_vat_metric:
              label: 'Flash Price inc VAT (1 Unit)'
              type: sum
              description: "Flash price inc VAT for 1 unit of the item"
              hidden: false
              round: 2
              group_label: 'Prices'      
      - name: flash_price_exc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            flash_price_exc_vat_metric:
              label: 'Flash Price exc VAT (All Units)'
              type: sum
              description: "Flash price exc VAT for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Prices'      
      - name: line_flash_price_exc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_flash_price_exc_vat_metric:
              label: 'Flash Price exc VAT (1 Unit)'
              type: sum
              description: "Flash price exc VAT for 1 unit of the item"
              hidden: false
              round: 2
              group_label: 'Prices'      
      - name: line_discount_amount
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_discount_amount_metric:
              label: 'Total Discount (£/€)'
              type: sum
              description: "Amount of discount granted inc VAT"
              hidden: false
              round: 2
              group_label: 'Sales'    
              round: 2    
      - name: line_discount_amount_exc_vat
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_discount_amount_metric:
              label: 'Discount amount exc VAT'
              type: sum
              description: "Amount of discount granted exc VAT"
              hidden: false
              round: 2    
      - name: line_shipping_incl_tax
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_shipping_incl_tax_metric:
              label: 'Shipping Amount (£/€) (inc Tax)'
              type: sum
              description: "Shipping incl tax for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Sales'
      - name: line_shipping_excl_tax
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_shipping_excl_tax_metric:
              label: 'Shipping Amount (£/€) (exc Tax)'
              type: sum
              description: "Shipping excl tax for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Sales'
      - name: line_shipping_tax
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            line_shipping_tax_metric:
              label: 'Shipping Tax Amount (£/€)'
              type: sum
              description: "Shipping tax for the full line of the order"
              hidden: false
              round: 2
              group_label: 'Sales'
      - name: margin
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            total_margin:
              label: 'Margin (£/€)'
              type: sum
              description: "Total Margin"
              hidden: false
              round: 0
              group_label: 'Sales'      
            total_margin_pct:
              label: 'Margin (%)'
              type: number
              description: "Total Margin (%)"
              sql: '100*safe_divide(${total_margin}, ${total_revenue_exc_tax})'
              round: 1
              group_label: 'Sales'     
      - name: line_total_refunded
        description: ""
        meta:
          dimension:
            hidden: true
            group_label: 'Sales'
      - name: shipping_refunded
        description: "Shipping refunded, nullable"
        meta:
          dimension:
            hidden: true
            group_label: 'Refunds'
      - name: category_path
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: marketing_category
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: product_type
        description: "Type of the product, nullable"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: brand
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: supplier_id
        description: "Supplier id"
        meta:
          dimension:
            format: id
            group_label: 'Product Details'
      - name: supplier_name
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: colour
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: gender
        description: "Gender"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: size
        description: "Size"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: nego
        description: "Negotiation number"
        meta:
          dimension:
            format: id
            group_label: 'Product Details'
      - name: category_name
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: department_type
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: updated_at
        description: "Update time"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            group_label: 'Order Info'
            label: 'Order Updated At'
      - name: created_at
        description: "Creation time"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLines.ba_site = "FR",datetime(timestamp(OrderLines.created_at), "Europe/Paris"),datetime(timestamp(OrderLines.created_at), "Europe/London"))'
            group_label: 'Order Info'
            label: 'Order Created At'
      - name: order_status
        description: ""
        meta:
          dimension:
            group_label: 'Order Info'
      - name: tax_amount
        description: "Tax amount, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            total_tax_amount:
              type: sum
              group_label: 'Sales'
              label: 'Total Tax (£/€)'
      - name: tax_percent
        description: "Tax percent, nullable"
        meta:
          dimension:
            group_label: 'Order Info'
      - name: date_comp_exported
        description: "Catalog product negotiation date comp exported"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLines.ba_site = "FR",datetime(OrderLines.date_comp_exported, "Europe/Paris"),datetime(OrderLines.date_comp_exported, "Europe/London"))'
            group_label: 'Product Details'
      - name: cpn_date_flag
        description: "sfoi.created_at greater than cpn.date_comp_exported"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: rrp
        description: ""
        meta:
          dimension:    
            type: number
            label: 'RRP' 
            description: 'Recommended Price'
            group_label: 'Product Details'
      - name: parent_sku
        description: ""
        meta:
          dimension:
            group_label: 'Product Details'
      - name: parent_sku_offset
        description: ""
        meta:
          dimension:
            hidden: true
      - name: reference
        description: "Reference"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: region
        description: "Region"
        meta:
          dimension:
            group_label: 'Customer Details'       
      - name: qty_backordered
        description: "Quantity backordered"
        meta:
          dimension:
            group_label: 'Product Details'       
      - name: sap_ref
        description: "SAP Reference number"   
        meta: 
          dimension:
            group_label: 'Product Details'    
      - name: cpn_status
        description: "catalog_product_negotiation status"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: product_category_level_1
        description: "Highest level of product category"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: product_category_level_2
        description: "Second highest level of product category"
        meta:
          dimension:
            group_label: 'Product Details'
      - name: product_category_level_3
        description: "Lowest level of product category"
        meta:
          dimension:
            group_label: 'Product Details'
      # - name: TOTAL_GBP_after_vouchers
      - name: total_local_currency_after_vouchers
        meta:
          dimension:
            hidden: true
          metrics:
            total_revenue:
              label: 'GMV (£/€)'
              type: sum
              description: "Total revenue inc VAT in local currency after taking vouchers into account"
              hidden: false
              round: 0
              group_label: 'Sales'
      # - name: TOTAL_GBP_before_vouchers   
      - name: total_local_currency_before_vouchers
        meta:
          dimension:
            hidden: true
          metrics:
            total_revenue_before_vouchers:
              label: 'Total Revenue (£/€) (inc VAT, before vouchers)'
              type: sum
              description: "Total revenue inc VAT in local currency before taking vouchers into account"
              hidden: false
              round: 0
              group_label: 'Sales'
      # - name: TOTAL_GBP_ex_tax_after_vouchers 
      - name: total_local_currency_ex_tax_after_vouchers
        meta:
          dimension:
            hidden: true
          metrics:
            total_revenue_exc_tax:
              label: 'Sales Amount (£/€)'
              type: sum
              description: "Total revenue exc VAT in local currency after taking vouchers into account"
              hidden: false
              round: 0
              group_label: 'Sales'
            average_order_value:
              label: 'AOV Sales (£/€)'
              type: number 
              description: 'Average order value (excluding VAT after discount)'
              sql: "${total_revenue_exc_tax}/${total_orders_count}"
              round: 0
              group_label: 'Sales'
      # - name: TOTAL_GBP_ex_tax_before_vouchers
      - name: total_local_currency_ex_tax_before_vouchers
        meta:
          dimension:
            hidden: true
          metrics:
            total_revenue_exc_tax_before_vouchers:
              label: 'Total Revenue (£/€) (exc VAT, before vouchers)'
              type: sum
              description: "Total revenue ex VAT in local currency before taking vouchers into account"
              hidden: false
              round: 0
              group_label: 'Sales'
      - name: qty_to_ship
        data_type: <integer>
        description: "number of items still to ship"
        meta:
          dimension:
            hidden: true
          metrics:
            total_qty_to_ship:
              type: sum
              group_label: 'Units'
              label: 'Units To Ship'
      - name: shipping_order
        description: "Index of the shipment for orders"
        meta:
          dimension:
            group_label: 'Shipping'

  - name: OrderLinesNullParent
    description: ""
    columns:
      - name: ba_site
      - name: order_id
        description: "Id of the order"
        tests:
          - not_null
        meta:
          metrics:
            total_order_count_nullParent:
              type: count_distinct 
              sql: "${ba_site} || ${order_id}"
      - name: category
        description: "Category of the order"       
      - name: customer_id
        description: "Customer id, foreign key, nullable"
        meta:
          metrics:
            total_customers:
              label: 'Total number of customers'
              type: count_distinct
              description: "Number of customers who ordered"
              hidden: false
              round: 2      
              sql: "${ba_site} || ${customer_id}"
      - name: status
        description: "Status of the order"
      - name: item_id
        description: "Item ID"
        meta:
          dimension:
            format: id
      - name: created_at
        description: "Creation date of the order"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLinesNullParent.ba_site = "FR",datetime(OrderLinesNullParent.created_at, "Europe/Paris"),datetime(OrderLinesNullParent.created_at, "Europe/London"))'
      - name: line_created_at
        description: "Creation date of the order line"
      - name: customer_name
        description: "Name of the customer"
      - name: sku
        description: "SKU ordered"
      - name: qty_canceled
        description: "Quantity canceled, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_canceled_metric:
              label: 'Units quantity cancelled'
              type: sum
              description: "Number of units cancelled"
              hidden: false
              round: 2      
      - name: qty_ordered
        description: "Quantity ordered, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_ordered_metric:
              label: 'Units quantity ordered'
              type: sum
              description: "Number of units ordered"
              hidden: false
              round: 2      
      - name: qty
        description: "Quantity invoiced, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_invoiced_metric:
              label: 'Units quantity invoiced'
              type: sum
              description: "Number of units invoiced"
              hidden: false
              round: 2      
      - name: qty_refunded
        description: "Quantity refunded, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_refunded_metric:
              label: 'Units quantity refunded'
              type: sum
              description: "Number of units refunded"
              hidden: false
              round: 2      
      - name: qty_refunded_hold
        description: "Quantity refunded on hold, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_refunded_hold_metric:
              label: 'Units quantity refund on hold'
              type: sum
              description: "Number of units refund on hold"
              hidden: false
              round: 2      
      - name: qty_shipped
        description: "Quantity shipped, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_shipped_metric:
              label: 'Units quantity shipped'
              type: sum
              description: "Number of units shipped"
              hidden: false
              round: 2      
      - name: qty_reserved
        description: "Quantity shipped, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_reserved_by_tc_metric:
              label: 'Units quantity reserved by tc'
              type: sum
              description: "Number of units reserved by tc"
              hidden: false
              round: 2      
      - name: qty_out_of_stock
        description: "Quantity out of stock, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_out_of_stock_metric:
              label: 'Units quantity out of stock'
              type: sum
              description: "Number of units out of stock"
              hidden: false
              round: 2      
      - name: qty_backordered
        description: "Quantity backordered, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_backordered_metric:
              label: 'Units quantity backordered'
              type: sum
              description: "Number of units backordered"
              hidden: false
              round: 2      
      - name: qty_warehouse_sent
        description: "Quantity sent from warehouse, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_warehouse_sent_metric:
              label: 'Units quantity sent from warehouse'
              type: sum
              description: "Units quantity sent from warehouse"
              hidden: false
              round: 2      
      - name: qty_backorder_reconciliation
        description: "Quantity backorder reconciliation, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_backorder_reconciliation_metric:
              label: 'Units quantity backorder reconciliation'
              type: sum
              description: "Units quantity backorder reconciliation"
              hidden: false
              round: 2      
      - name: qty_wh_b_sent
        description: "Quantity warehouse b sent, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_wh_b_sent_metric:
              label: 'Units quantity warehouse b sent'
              type: sum
              description: "Units quantity warehouse b sent"
              hidden: false
              round: 2      
      - name: qty_reserved_by_wh_b
        description: "Quantity reserved by warehouse b, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_reserved_by_wh_b_metric:
              label: 'Units quantity reserved by warehouse b'
              type: sum
              description: "Units quantity reserved by warehouse b"
              hidden: false
              round: 2      
      - name: qty_to_ignore
        description: "Quantity to ignore, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_to_ignore_metric:
              label: 'Units quantity to ignore'
              type: sum
              description: "Units quantity to ignore"
              hidden: false
              round: 2      
      - name: qty_to_send
        description: "Quantity to send, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_to_send_metric:
              label: 'Units quantity to send'
              type: sum
              description: "Units quantity to send"
              hidden: false
              round: 2      
      - name: qty_orders_due
        description: "Quantity to send, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_orders_due_metric:
              label: 'Units quantity of orders due'
              type: sum
              description: "Units quantity of orders due"
              hidden: false
              round: 2      
      - name: qty_backorder_not_shipped
        description: "Quantity of backorders not shipped, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            qty_backorder_not_shipped_metric:
              label: 'Units quantity of backorders not shipped'
              type: sum
              description: "Units quantity of backorders not shipped"
              hidden: false
              round: 2      
      - name: price
        description: "Price of the unit"
      - name: dispatch_date
        description: "Dispatch date"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLinesNullParent.ba_site = "FR",datetime(OrderLinesNullParent.dispatch_date, "Europe/Paris"),datetime(OrderLinesNullParent.dispatch_date, "Europe/London"))'
      - name: delivery_address
        description: "Address of delivery"
      - name: method
        description: "Method"
      - name: last_trans_id
        description: "Last transaction id"
        meta:
          dimension:
            format: id
      - name: MagentoID
        description: "Magento Id"
        meta:
          dimension:
            format: id
      - name: name
        description: "Product name"
      - name: nego
        description: "Negotiation number"
        meta:
          dimension:
            format: id
      - name: boreco_or_reswhb
        description: "Flag indicating if qty_backorder_reconciliation > 0  or qty_reserved_by_wh_b > 0"

  - name: OrderLinesWithParent
    description: ""
    meta:
      joins:
        - join: stg__customer_entity
          sql_on: ${OrderLinesWithParent.store_id} = ${stg__customer_entity.store_id} and ${OrderLinesWithParent.ba_site} = ${stg__customer_entity.ba_site}
    columns:
      - name: ba_site
      - name: increment_id
        description: "Id of the order"
        tests:
          - not_null
        meta:
          metrics:
            total_order_count_nullParent:
              type: count_distinct 
      - name: brand
        description: "Brand of the line ordered"       
      - name: customer_id
        description: "Customer id, foreign key, nullable"
        meta:
          metrics:
            total_customers:
              label: 'Total number of customers'
              type: count_distinct
              description: "Number of customers who ordered"
              hidden: false
              round: 2      
      - name: subscriber_status
        description: "Status of the newsletter subscribment"
      - name: created_at
        description: "Creation date of the order"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(OrderLinesWithParent.ba_site = "FR",datetime(OrderLinesWithParent.created_at, "Europe/Paris"),datetime(OrderLinesWithParent.created_at, "Europe/London"))'
      - name: product_type
        description: "Type of product ordered"
      - name: parent_item_id
        description: "Id of the parent item"
        meta:
          dimension:
            format: id
      - name: store_id
        description: "Brand store id"
        meta:
          dimension:
            format: id
      - name: total_gbp
        description: "Total value of the order before vouchers"
        meta:
          dimension:
            hidden: true
          metrics:
            total_gbp_metric:
              label: 'Total value of the order before vouchers'
              type: sum
              description: "Total value of the order before vouchers"
              hidden: false
              round: 2      
      - name: total_gbp_after_vouchers
        description: "Total value of the order after vouchers"
        meta:
          dimension:
            hidden: true
          metrics:
            total_gbp_after_vouchers_metric:
              label: 'Total value of the order after vouchers'
              type: sum
              description: "Total value of the order after vouchers"
              hidden: false
              round: 2   
     
  - name: orders_enriched
    columns:
      - name: ba_site_increment_id
        tests:
          - not_null
          - unique
      - name: ba_site
      - name: order_id
        meta:
          dimension:
            format: id
      - name: increment_id
      - name: customer_id
        meta:
          dimension:
            format: id
      - name: order_at
      - name: order_sequence
        meta:
          dimension:
            type: number
      - name: is_first_order
        meta:
          dimension:
            type: boolean
      - name: order_number_excl_full_refunds
        meta:
          dimension:
            type: number
      - name: order_number_incl_cancellations
        meta:
          dimension:
            type: number
      - name: days_since_first_purchase
        meta:
          dimension:
            type: number
          metrics:
            average_days_since_first_purchase_metric:
              label: 'Average days since first purchase'
              type: average
              description: "Average days since first purchase"
              hidden: false
              round: 0
      - name: coupon_code
      - name: coupon_name
      - name: coupon_type
      - name: coupon_type_label
      - name: order_revenue_excl_tax_after_vouchers
        meta:
          dimension:
            type: number
          metrics:
            average_order_value_metric:
              label: 'AOV'
              type: average
              description: "AOV"
              hidden: false
              round: 2 
            total_order_value_metric:
              label: 'Total Order Revenue'
              type: average
              description: "Total Order Revenue"
              hidden: false
              round: 2 
      - name: order_product_costs_excl_tax
        meta:
          dimension:
            type: number
          metrics:
            total_product_costs_metric:
              label: 'Total product costs'
              type: sum
              description: "Total product costs"
              hidden: false
              round: 2 
      - name: order_margin
        meta:
          dimension:
            type: number
          metrics:
            total_order_margin_metric:
              label: 'Total margin'
              type: sum
              description: "Total margin"
              hidden: false
              round: 2 
      - name: count_order_lines
        meta:
          metrics:
            dimension:
              type: number
      - name: count_refunds
        meta:
          metrics:
            dimension:
              type: number
            total_refunds_count_metric:
              label: 'Total number of refunds'
              type: sum
              description: "Total number of refunds"
              hidden: false
      - name: count_refunds_split_per_order_item
        meta:
          metrics:
            total_refunds_split_per_order_item_count_metric:
              label: 'Total number of refunds split per order item'
              type: sum
              description: "Total number of refunds split per order item"
              sql: "${count_refunds}/${count_order_lines}"
              hidden: false
              round: 0
      - name: count_item_refunds
        meta:
          metrics:
            dimension:
              type: number
            total_item_refunds_count_metric:
              label: 'Total number of item refunds'
              type: sum
              description: "Total number of item refunds"
              hidden: false
      - name: count_item_refunds_split_per_order_item
        meta:
          metrics:
            total_item_refunds_split_per_order_item_count_metric:
              label: 'Total number of item refunds split per order item'
              type: sum
              description: "Total number of item refunds split per order item"
              sql: "${count_item_refunds}/${count_order_lines}"
              hidden: false
              round: 0
      - name: total_refund_amount_split_per_order_item
        meta:
          metrics:
            total_refund_amount_split_per_order_item_metric:
              label: 'Total refund amount split per order item'
              type: sum
              description: "Total refund amount split per order item"
              sql: "${total_refund_amount}/${count_order_lines}"
              round: 0 
      - name: total_refund_amount
        meta:
          metrics:
            total_refund_amount_metric:
              label: 'Total Refund Amount'
              type: sum
              description: "Total refund amount" 
      - name: has_ordered_since
        meta:
          dimension:
            type: boolean
          metrics:
            total_customers_with_subsequent_order:
              label: 'Customers with subsequent order'
              type: count_distinct
              description: "Number of customers who have returned to make another order"
              hidden: false
              sql: "if(${has_ordered_since}, ${customer_id}, null)"
            total_new_customers_with_subsequent_order:
              label: 'New customers with subsequent order'
              type: count_distinct
              description: "Number of new customers who have returned to make another order"
              hidden: false
              sql: "if(${has_ordered_since} and ${order_sequence} = 1, ${customer_id}, null)"

  - name: Orders
    description: "A table of order information, unique at order id level"
    meta:
      joins:
        - join: shipments
          sql_on: ${Orders.order_id} = ${shipments.order_id} and ${Orders.ba_site} = ${shipments.ba_site}
        - join: stg__salesrule_coupon
          sql_on: ${Orders.coupon_code} = ${stg__salesrule_coupon.code} and  ${Orders.ba_site} = ${stg__salesrule_coupon.ba_site}
        - join: stg__salesrule
          sql_on: ${stg__salesrule_coupon.rule_id} = ${stg__salesrule.rule_id} and ${stg__salesrule_coupon.ba_site} = ${stg__salesrule.ba_site}
        - join: customers_enriched 
          sql_on: ${Orders.customer_id} = ${customers_enriched.customer_id} and ${Orders.ba_site} = ${customers_enriched.ba_site}
        - join: orders_enriched 
          sql_on: ${Orders.order_id} = ${orders_enriched.order_id} and ${Orders.ba_site} = ${orders_enriched.ba_site}
        - join: stg__sales_payment_transaction 
          sql_on: ${Orders.order_id} = ${stg__sales_payment_transaction.order_id} and ${stg__sales_payment_transaction.parent_id} is null  and ${Orders.ba_site} = ${stg__sales_payment_transaction.ba_site}
    columns:
      - name: ba_site_increment_id
        tests:
          - not_null
          - unique
        meta:
          metrics:
            total_order_count:
              label: 'Total Orders'
              type: count_distinct
              description: "Number of orders"
              round: 0
            total_new_order_count:
              label: 'Total New Orders'
              type: count_distinct
              description: "Number of new orders"
              sql: "IF(${orderno}=1, ${ba_site_increment_id}, null)"
              round: 0
            total_returning_order_count:
              label: 'Total Returning Orders'
              type: count_distinct
              description: "Number of returning orders"
              sql: "IF(${orderno}>1, ${ba_site_increment_id}, null)"
              round: 0
      - name: ba_site
      - name: increment_id
        description: "Increment id, nullable"
      - name: order_id
        description: ""
        meta:
          dimension:
            format: id
      - name: store_id
        description: "Store id, foreign key, nullable"
        meta:
          dimension:
            format: id
      - name: billing_address_id
        description: "Id of the billing address, foreign key, nullable"
        meta:
          dimension:
            format: id
      - name: shipping_address_id
        description: "Shipping address id, foreign key, nullable"
        meta:
          dimension:
            format: id
      - name: subtotal_incl_tax
        description: "Adjustment negative, nullable"
      - name: subtotal_excl_tax
        description: ""
      - name: total_discount_amount
        description: ""
      - name: shipping_discount_amount
        description: "Adjustment negative, nullable"
      - name: total_tax
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            orders_total_tax:
              label: 'Total Orders Tax Amount (£/€)'
              type: sum
              description: "Order's total tax amount"
              hidden: false
              round: 2      
      - name: total_qty_ordered
        description: "Total quantity ordered"
      - name: shipping_excl_tax
        description: ""
        meta:
          dimension:
            hidden: true
          metrics:
            shipping_excl_tax_metric:
              label: 'Shipping exc Tax'
              type: sum
              description: "Shipping exc Tax"
              hidden: false
              round: 2      
            shipping_excl_tax_per_qty_metric:
              label: 'Shipping excl Tax per unit'
              type: sum
              description: "Shipping excl Tax per unit"
              sql: "safe_divide(${shipping_excl_tax},${total_qty_ordered})"
              hidden: false
              round: 2      
      - name: shipping_incl_tax
        description: "Shipping including tax, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            shipping_incl_tax_metric:
              label: 'Shipping inc Tax'
              type: sum
              description: "Shipping inc Tax"
              hidden: false
              round: 2      
            shipping_incl_tax_per_qty_metric:
              label: 'Shipping inc Tax per unit'
              type: sum
              description: "Shipping inc Tax per unit"
              sql: "safe_divide(${shipping_incl_tax},${total_qty_ordered})"
              hidden: false
              round: 2      
      - name: grand_total
        description: "Grand total, nullable"
        meta:
          dimension:
            hidden: true
          metrics:
            orders_grand_total:
              label: 'Order Grand Total'
              type: sum
              description: "Order grand total"
              hidden: false
              round: 2      
      - name: total_paid
        description: "Total paid, nullable"
      - name: total_refunded
        description: "Total refunded, nullable"
      - name: total_due
        description: "Adjustment negative, nullable"
      - name: total_invoiced_cost
        description: ""
      - name: status
        description: "Status, nullable"
      - name: coupon_rule_name
        description: "Coupon rule name, nullable"
      - name: coupon_code
        description: "Coupon code, nullable"
      - name: method
        description: "Method, nullable"
      - name: shipping_method
        description: "Shipping method, nullable"
      - name: shipping_description
        description: "Shipping description, nullable"
      - name: customer_id
        description: "Customer id, foreign key, nullable"
        meta: 
          metrics:
            total_customers_count:
              label: 'Total Customers'
              type: count_distinct
              description: "Number of customers"
              sql: "${ba_site} || ${customer_id}"
            new_customers:
              label: 'Total New Customers'
              type: count_distinct
              description: "Number of new customers"
              sql: "IF(${orderno}=1, ${ba_site} || ${customer_id}, null)"
              hidden: false    
            returning_customers:
              label: 'Total Returning Customers'
              type: count_distinct
              description: "Number of new customers"
              sql: "IF(${orderno}>1, ${ba_site} || ${customer_id}, null)"
              hidden: false
            new_customers_pct:
              label: 'New Customer (%)'
              type: number
              sql: 'safe_divide(${new_customers},${total_customers_count})'
              format: percent
      - name: delivery_postcode
        description: ""
      - name: expected_delivery_date
        description: "Expected delivery date"
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
      - name: expected_delivery_days
        description: "Expected delivery days, nullable"
      - name: created_at
        description: ""
        meta:
          dimension:
            type: timestamp
            time_intervals: ['RAW', 'SECOND', 'MINUTE', 'HOUR', 'DAY', 'WEEK', 'MONTH', 'QUARTER', 'YEAR', 'DAY_OF_WEEK_NAME', 'MONTH_NAME', 'QUARTER_NAME']
            sql: 'if(Orders.ba_site = "FR",datetime(Orders.created_at, "Europe/Paris"),datetime(Orders.created_at, "Europe/London"))'
      - name: updated_at
        description: "Update date of the order, nullable"
      - name: orderno
        description: "Order index placed by the client at Brandalley"
      - name: order_number_incl_cancellations
      - name: cc_trans_id
        description: "CC Transaction Id"
        meta:
          dimension:
            format: id
      - name: additional_information
        description: "Additional information"
      - name: base_grand_total
        data_type: <decimal>
        description: "Base Grand Total"
      - name: interval_between_orders
        description: " customer interval between orders (in days) "
      - name: total_interval_between_orders_for_each_customer
        description: " the total count of intervals between orders for each customer (in days)"
        meta: 
          dimension:
            type: number
      - name: country_id
        description: "shipping country"